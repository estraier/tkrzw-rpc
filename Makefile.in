# Makefile for Tkrzw RPC

#================================================================
# Setting Variables
#================================================================

# Generic settings
SHELL := @SHELL@

# Package information
PACKAGE := @PACKAGE_NAME@
VERSION := @PACKAGE_VERSION@
PACKAGEDIR := $(PACKAGE)-$(VERSION)
PACKAGETGZ := $(PACKAGE)-$(VERSION).tar.gz
LIBVER := @MYLIBVER@
LIBREV := @MYLIBREV@

# Targets
HEADERFILES := @MYHEADERFILES@
LIBRARYFILES := @MYLIBRARYFILES@
LIBOBJFILES := @MYLIBOBJFILES@
COMMANDFILES := @MYCOMMANDFILES@
TESTFILES := @MYTESTFILES@

# Install destinations
prefix := @prefix@
exec_prefix := @exec_prefix@
datarootdir := @datarootdir@
LIBDIR := @libdir@
BINDIR := @bindir@
LIBEXECDIR := @libexecdir@
PCDIR := @libdir@/pkgconfig
DESTDIR =

# Building configuration
PROTOC := @PROTOC@
GRPCCPP := @GRPCCPP@
CXX := @CXX@
CPPFLAGS := @MYCPPFLAGS@ -D_TKSERV_PKG_VERSION="\"$(VERSION)\""
CXXFLAGS := @MYCXXFLAGS@
LDFLAGS := @MYLDFLAGS@
CMDLDFLAGS := @MYCMDLDFLAGS@
CMDLIBS := @MYCMDLIBS@
TESTLIBS := @MYTESTLIBS@
LIBS := @LIBS@
RUNENV := @MYLDLIBPATHENV@=@MYLDLIBPATH@

#================================================================
# Actions
#================================================================

all : $(LIBRARYFILES) $(COMMANDFILES)
	@printf '\n'
	@printf '#================================================================\n'
	@printf '# Ready to install.\n'
	@printf '#================================================================\n'

clean :
	rm -rf $(LIBRARYFILES) $(LIBOBJFILES) $(COMMANDFILES) $(TESTFILES)
	rm -rf *.pb.h *.pb.cc *.o *.d a.out *.class check.in check.out gmon.out *.vlog \
	  casket* *.tkh *.tkt *.tks *.flat *.log *~ hoge moge tako ika uni

untabify :
	ls *.cc *.h *.java | while read name ; \
	  do \
	    sed -e 's/\t/        /g' -e 's/ *$$//' $$name > $$name~; \
	    [ -f $$name~ ] && mv -f $$name~ $$name ; \
	  done

install :
	mkdir -p $(DESTDIR)$(INCLUDEDIR)
	[ ! -f tkrzw_lib_commons.h -a -f ../tkrzw_lib_common.h ] && cd .. ; \
	  cp -Rf $(HEADERFILES) $(DESTDIR)$(INCLUDEDIR)
	mkdir -p $(DESTDIR)$(LIBDIR)
	cp -Rf $(LIBRARYFILES) $(DESTDIR)$(LIBDIR)
	mkdir -p $(DESTDIR)$(BINDIR)
	cp -Rf $(COMMANDFILES) $(DESTDIR)$(BINDIR)
	@printf '\n'
	@printf '#================================================================\n'
	@printf '# Thanks for using Kyoto Cabinet for Java.\n'
	@printf '#================================================================\n'

uninstall :
	-cd $(DESTDIR)$(INCLUDEDIR) && rm -f $(HEADERFILES)
	-cd $(DESTDIR)$(LIBDIR) && rm -f $(LIBRARYFILES)
	-cd $(DESTDIR)$(BINDIR) && rm -f $(COMMANDFILES)

dist :
	$(MAKE) untabify
	$(MAKE) distclean
	rm -Rf "../$(PACKAGEDIR)" "../$(PACKAGETGZ)"
	cd .. && cp -R tkrzw-java $(PACKAGEDIR) && \
	  tar --exclude=".*" -cvf - $(PACKAGEDIR) | gzip -c > $(PACKAGETGZ)
	rm -Rf "../$(PACKAGEDIR)"
	sync ; sync

distclean : clean apidocclean
	[ ! -f example/Makefile ] || cd example && $(MAKE) clean
	rm -Rf Makefile tkrzw-rpc.pc \
	  config.cache config.log config.status config.tmp autom4te.cache build

check :
	$(MAKE) check-client
	$(MAKE) check-perf

check-client :
	$(RUNENV) ./tkrzw_client echo "hello"
	$(RUNENV) ./tkrzw_client inspect --index -1
	$(RUNENV) ./tkrzw_client inspect
	$(RUNENV) ./tkrzw_client set "one" "first"
	$(RUNENV) ./tkrzw_client set "two" "second"
	$(RUNENV) ./tkrzw_client get "one"
	$(RUNENV) ./tkrzw_client remove "one"
	$(RUNENV) ./tkrzw_client rebuild
	$(RUNENV) ./tkrzw_client sync
	$(RUNENV) ./tkrzw_client get "two"
	$(RUNENV) ./tkrzw_client clear

check-perf :
	$(RUNENV) ./tkrzw_perf sequence --threads 1 --iter 100000
	$(RUNENV) ./tkrzw_perf sequence --threads 4 --iter 25000 --random_key --random_value

test : $(TESTFILES)

testrun :
	$(RUNENV) ./tkrzw_server_test
	$(RUNENV) ./tkrzw_rpc_test

apidoc :
	$(MAKE) apidocclean
	mkdir -p api-doc
	doxygen

apidocclean :
	rm -rf api-doc api-doc-tmp

.PHONY : all clean install casket check apidoc apidocclean

#================================================================
# Suffix rules
#================================================================

OBJS := $(LIBOBJFILES) $(COMMANDFILES:%=%.o) $(TESTFILES:%=%.o)
SRCS := $(OBJS:%.o=%.c)
DEPS := $(SRCS:%.c=%.d)

-include $(DEPS)

.SUFFIXES :
.SUFFIXES : .cc .o

.cc.o :
	$(CXX) -c $(CPPFLAGS) -MMD $(CXXFLAGS) $<

#================================================================
# Building protocol buffers
#================================================================

tkrzw_rpc.pb.h tkrzw_rpc.pb.cc : tkrzw_rpc.proto
	$(PROTOC) -I . --cpp_out=. tkrzw_rpc.proto

tkrzw_rpc.grpc.pb.h tkrzw_rpc.grpc.pb.cc tkrzw_rpc_mock.grpc.pb.h : tkrzw_rpc.proto
	$(PROTOC) -I . --grpc_out=generate_mock_code=true:. \
	  --plugin=protoc-gen-grpc=$(GRPCCPP) tkrzw_rpc.proto

#================================================================
# Building libraries
#================================================================

libtkrzw_rpc.a : $(LIBOBJFILES)
	$(AR) $(ARFLAGS) $@ $(LIBOBJFILES)

tkrzw_rpc.o : tkrzw_rpc.pb.h tkrzw_rpc.grpc.pb.h

#================================================================
# Building binaries
#================================================================

tkrzw_server : tkrzw_server.o tkrzw_server_util.o $(LIBRARYFILES)
	$(CXX) $(CXXFLAGS) -o $@ $< tkrzw_server_util.o $(LDFLAGS) $(CMDLDFLAGS) $(CMDLIBS) $(LIBS)

tkrzw_client : tkrzw_client.o $(LIBRARYFILES)
	$(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) $(CMDLIBS) $(LIBS)

tkrzw_perf : tkrzw_perf.o $(LIBRARYFILES)
	$(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) $(CMDLIBS) $(LIBS)

#================================================================
# Building tests
#================================================================

tkrzw_server_test.o : tkrzw_server_impl.h tkrzw_rpc.pb.h tkrzw_rpc.grpc.pb.h

tkrzw_server_test : tkrzw_server_test.o $(LIBRARYFILES) 
	$(CXX) $(CXXFLAGS) -o $@ $< $(CMDLDFLAGS) $(CMDLIBS) $(TESTLIBS) $(LIBS)

tkrzw_rpc_test.o : tkrzw_rpc.pb.h tkrzw_rpc_mock.grpc.pb.h

tkrzw_rpc_test : tkrzw_rpc_test.o $(LIBRARYFILES)
	$(CXX) $(CXXFLAGS) -o $@ $< $(CMDLDFLAGS) $(CMDLIBS) $(TESTLIBS) $(LIBS)

# END OF FILE
